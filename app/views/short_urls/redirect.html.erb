<!DOCTYPE html>
<html>
<head>
  <title>Redirecting...</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .loader {
      text-align: center;
      color: white;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }
    p {
      margin: 10px 0 0;
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="loader">
    <div class="spinner"></div>
    <h2>Redirecting...</h2>
    <p>Please wait</p>
  </div>

<script>
    (function() {
      
      const shortUri = '<%= @short_url.short_uri %>';
      const url1 = '<%= @short_url.url1 %>';
      const url2 = '<%= @short_url.url2.present? ? @short_url.url2 : "" %>';
      const csrfToken = '<%= form_authenticity_token %>';
      
      const trackingKey = `winkly_${shortUri}`;

      // Extract UTM parameters from current URL
      function getUtmParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
          utm_source: urlParams.get('utm_source') || null,
          utm_medium: urlParams.get('utm_medium') || null,
          utm_campaign: urlParams.get('utm_campaign') || null,
          utm_term: urlParams.get('utm_term') || null,
          utm_content: urlParams.get('utm_content') || null
        };
      }

      // Function to get or create a unique visitor ID
      function getVisitorId() {
        let visitorId;
        try {
          visitorId = localStorage.getItem('winkly_visitor_id');
        } catch (e) {
          visitorId = sessionStorage.getItem('winkly_visitor_id');
        }
        
        if (!visitorId) {
          visitorId = Array.from(crypto.getRandomValues(new Uint8Array(16)))
            .map(b => b.toString(16).padStart(2, '0'))
            .join('');
          
          try {
            localStorage.setItem('winkly_visitor_id', visitorId);
          } catch (e) {
            sessionStorage.setItem('winkly_visitor_id', visitorId);
          }
        } else {
          console.log('Found EXISTING visitor ID:', visitorId);
        }
        return visitorId;
      }
      
      // Function to send tracking data to server (ClickHouse)
      async function trackClick(urlType, redirectUrl) {
        const utmParams = getUtmParameters();
        
        const trackingData = {
          url_type: urlType,
          redirected_url: redirectUrl,
          visitor_id: getVisitorId(),
          user_agent: navigator.userAgent,
          timestamp: new Date().toISOString(),
          // Include UTM parameters
          utm_source: utmParams.utm_source,
          utm_medium: utmParams.utm_medium,
          utm_campaign: utmParams.utm_campaign,
          utm_term: utmParams.utm_term,
          utm_content: utmParams.utm_content
        };
        
        console.log('ðŸ“Š Tracking click with UTM params:', utmParams);
        
        // Use sendBeacon as primary method (more reliable on mobile)
        if (navigator.sendBeacon) {
          try {
            const blob = new Blob([JSON.stringify(trackingData)], { type: 'application/json' });
            const success = navigator.sendBeacon(
              `/${shortUri}/track`,
              blob
            );
            if (success) {
              console.log('âœ“ Click tracked via sendBeacon with UTM params');
              return true;
            }
          } catch (error) {
            console.error('sendBeacon failed:', error);
          }
        }
        
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000);
          
          const response = await fetch(`/${shortUri}/track`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken,
              'Accept': 'application/json'
            },
            body: JSON.stringify(trackingData),
            keepalive: true,
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (response.ok) {
            const result = await response.json();
            console.log('âœ“ Click tracked via fetch with UTM params:', result);
            return true;
          } else {
            const errorText = await response.text();
            console.error('âœ— Tracking failed:', errorText);
            return false;
          }
        } catch (error) {
          console.error('âœ— Tracking error:', error);
          return false;
        }
      }
      
      function getRedirectUrl() {
        if (!url2 || url2 === '') {
          return { url: url1, type: 'url1' };
        }
        
        const visitorId = getVisitorId();
        let trackingData;
        
        try {
          trackingData = localStorage.getItem(trackingKey);
        } catch (e) {
          try {
            trackingData = sessionStorage.getItem(trackingKey);
          } catch (e2) {
            trackingData = null;
          }
        }
        
        if (trackingData) {
          try {
            const data = JSON.parse(trackingData);
            
            if (data.visitorId === visitorId) {
              const lastUrl = data.lastUrl;
              const nextUrl = lastUrl === url1 ? url2 : url1;
              const nextType = lastUrl === url1 ? 'url2' : 'url1';
              
              const newTrackingData = {
                visitorId: visitorId,
                lastUrl: nextUrl,
                clickCount: (data.clickCount || 0) + 1,
                lastVisit: new Date().toISOString()
              };
              
              try {
                localStorage.setItem(trackingKey, JSON.stringify(newTrackingData));
              } catch (e) {
                sessionStorage.setItem(trackingKey, JSON.stringify(newTrackingData));
              }
              
              return { url: nextUrl, type: nextType };
            } else {
              // Different visitor - start fresh with url1
              const newTrackingData = {
                visitorId: visitorId,
                lastUrl: url1,
                clickCount: 1,
                lastVisit: new Date().toISOString()
              };
              
              try {
                localStorage.setItem(trackingKey, JSON.stringify(newTrackingData));
              } catch (e) {
                sessionStorage.setItem(trackingKey, JSON.stringify(newTrackingData));
              }
              
              return { url: url1, type: 'url1' };
            }
          } catch (e) {
            const newTrackingData = {
              visitorId: visitorId,
              lastUrl: url1,
              clickCount: 1,
              lastVisit: new Date().toISOString()
            };
            
            try {
              localStorage.setItem(trackingKey, JSON.stringify(newTrackingData));
            } catch (err) {
              sessionStorage.setItem(trackingKey, JSON.stringify(newTrackingData));
            }
            
            return { url: url1, type: 'url1' };
          }
        } else {
          const newTrackingData = {
            visitorId: visitorId,
            lastUrl: url1,
            clickCount: 1,
            lastVisit: new Date().toISOString()
          };
          
          try {
            localStorage.setItem(trackingKey, JSON.stringify(newTrackingData));
          } catch (e) {
            sessionStorage.setItem(trackingKey, JSON.stringify(newTrackingData));
          }
          return { url: url1, type: 'url1' };
        }
      }
      
      // Main execution
      async function executeRedirect() {
        try {
          // Get the target URL
          const redirectInfo = getRedirectUrl();

          // Track the click with UTM parameters
          const trackingPromise = trackClick(redirectInfo.type, redirectInfo.url);
          
          // Wait for tracking with max 2 second timeout
          const timeoutPromise = new Promise(resolve => setTimeout(resolve, 2000));
          await Promise.race([trackingPromise, timeoutPromise]);
          
          // Redirect
          window.location.href = redirectInfo.url;
          
        } catch (error) {
          console.error('Redirect error:', error);
          // Still redirect even if tracking fails
          const redirectInfo = getRedirectUrl();
          window.location.href = redirectInfo.url;
        }
      }
      
      // Start the redirect process
      executeRedirect();
    })();
  </script>
</body>
</html>