<%= render layout: 'layouts/dashboard_layout' do %>
  <div class="p-4 sm:p-6 lg:p-8">
    <% if flash[:notice] %>
      <div id="flash-notice" class="mb-6 bg-green-50 border border-green-200 rounded-xl p-4 flex items-start space-x-3 shadow-md animate-slideIn">
        <svg class="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div class="flex-1">
          <p class="text-sm font-medium text-green-800"><%= flash[:notice] %></p>
        </div>
        <button onclick="this.parentElement.remove()" class="text-green-600 hover:text-green-800">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    <% end %>
    <% if flash[:alert] %>
      <div id="flash-alert" class="mb-6 bg-red-50 border border-red-200 rounded-xl p-4 flex items-start space-x-3 shadow-md animate-slideIn">
        <svg class="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div class="flex-1">
          <p class="text-sm font-medium text-red-800"><%= flash[:alert] %></p>
        </div>
        <button onclick="this.parentElement.remove()" class="text-red-600 hover:text-red-800">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    <% end %>

   <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4 mb-8 border border-gray-100">
  <h2 class="text-2xl font-bold text-gray-900 mb-1">Create Short URL</h2>
  <p class="text-gray-500 text-sm mb-6">Create a short link that alternates between two destinations</p>

  <%= form_with url: short_urls_path, method: :post, local: true, id: "short-url-form" do |f| %>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Left Column: URL Inputs -->
      <div class="">
        <div>
          <label for="url1" class="block text-sm font-medium text-gray-700 mb-1.5">
            First URL <span class="text-red-500">*</span>
          </label>
          <input 
            type="url" 
            name="short_url[url1]" 
            id="url1" 
            required
            placeholder="https://example.com/page1"
            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
          />
          <div id="url1-validation" class="mt-1 text-xs min-h-[16px]"></div>
        </div>

        <div>
          <label for="url2" class="block text-sm font-medium text-gray-700 mb-1.5">
            Second URL <span class="text-gray-400 text-xs">(Optional)</span>
          </label>
          <input 
            type="url" 
            name="short_url[url2]" 
            id="url2"
            placeholder="https://example.com/page2"
            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
          />
          <div id="url2-validation" class="mt-1 text-xs min-h-[16px]"></div>
        </div>
      </div>

      <!-- Right Column: Custom Code and Button -->
      <div class="">
        <div>
          <label for="short_uri" class="block text-sm font-medium text-gray-700 mb-1.5">
            Custom Short Code <span class="text-gray-400 text-xs">(Optional)</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <span class="text-gray-500 text-sm font-mono">winkly.app/</span>
            </div>
            <input 
              type="text" 
              name="short_url[short_uri]" 
              id="short_uri"
              placeholder="my-link"
              pattern="[a-zA-Z0-9_-]+"
              class="w-full pl-28 pr-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition font-mono"
            />
          </div>
          <div id="short-uri-validation" class="mt-1 text-xs min-h-[16px]"></div>
        </div>

        <div class="flex items-end justify-end pt-5">
          <%= f.submit "Create Short URL", 
              id: "submit-button",
              class: "px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 shadow-sm transition cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed" %>
        </div>
      </div>
    </div>
  <% end %>
</div>
    
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 ml-1 mt-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">My Short URLs</h1>
        <p class="text-md text-gray-600 mt-1">Manage all your shortened links</p>
      </div>
     
    </div>

 <% if @short_urls.any? %>
  <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-200">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Short URL</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destination URLs</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clicks</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
        <% @short_urls.each do |short_url| %>
          <tr class="hover:bg-gray-50 transition">
            <td class="px-4 py-3 whitespace-nowrap">
              <div class="flex items-center space-x-2">
                <code class="text-xs font-mono text-indigo-600 bg-indigo-50 px-2 py-1 rounded border border-indigo-100">
                  <%= link_to "#{request.base_url}/#{short_url.short_uri}", short_redirect_path(short_url.short_uri), target: "_blank", class: "hover:underline" %>
                </code>
                <button onclick="copyToClipboard('<%= request.base_url %>/<%= short_url.short_uri %>')" class="text-gray-400 hover:text-indigo-600 transition" title="Copy to clipboard">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                </button>
              </div>
            </td>
            <td class="px-4 py-3 max-w-sm">
              <div class="text-xs space-y-1">
                <div class="text-gray-900 truncate" title="<%= short_url.url1 %>">
                  <span class="font-medium text-gray-600">URL 1:</span> <%= short_url.url1 %>
                </div>
                <% if short_url.url2.present? %>
                  <div class="text-gray-900 truncate" title="<%= short_url.url2 %>">
                    <span class="font-medium text-gray-600">URL 2:</span> <%= short_url.url2 %>
                  </div>
                <% else %>
                  <div class="text-gray-400 text-xs">No alternating URL</div>
                <% end %>
              </div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs font-semibold rounded-full bg-green-50 text-green-700 border border-green-100">
                <%= short_url.click_count %>
              </span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">
              <%= short_url.created_at.strftime("%b %d, %Y") %>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-xs font-medium">
              <div class="flex items-center space-x-2">
                <%= link_to stats_short_url_path(short_url), class: "text-indigo-600 hover:text-indigo-700 transition inline-flex items-center" do %>
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                  </svg>
                  Stats
                <% end %>
                <%= button_to "Delete", short_url_path(short_url), method: :delete, 
                    data: { confirm: "Are you sure you want to delete this short URL?" },
                    class: "text-red-600 hover:text-red-700 transition" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <div class="bg-white rounded-lg shadow-md p-8 text-center border border-gray-200">
    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
    </svg>
    <h3 class="mt-3 text-lg font-semibold text-gray-900">No short URLs yet</h3>
    <p class="mt-1 text-sm text-gray-500">Get started by creating your first short URL.</p>
    <%= link_to root_path, class: "mt-6 inline-flex items-center px-5 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 shadow-sm transition" do %>
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg>
      Create Short URL
    <% end %>
  </div>
<% end %>
  </div>

  <style>
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .animate-slideIn {
      animation: slideIn 0.3s ease-out;
    }
  </style>

  <script>
    // Real-time short URI validation
    const shortUriInput = document.getElementById('short_uri');
    const validationDiv = document.getElementById('short-uri-validation');
    const submitButton = document.getElementById('submit-button');
    let validationTimeout;

    shortUriInput.addEventListener('input', function() {
      clearTimeout(validationTimeout);
      const value = this.value.trim();

      if (value === '') {
        validationDiv.innerHTML = '<span class="text-gray-500">A random 5-character code will be generated</span>';
        submitButton.disabled = false;
        return;
      }

      // Check format first
      const validFormat = /^[a-zA-Z0-9_-]+$/.test(value);
      if (!validFormat) {
        validationDiv.innerHTML = '<span class="text-red-600">❌ Only letters, numbers, hyphens, and underscores allowed</span>';
        submitButton.disabled = true;
        return;
      }

      // Show loading state
      validationDiv.innerHTML = '<span class="text-gray-500">⏳ Checking availability...</span>';
      submitButton.disabled = true;

      validationTimeout = setTimeout(() => {
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        
        if (!csrfToken) {
          console.error('CSRF token not found');
          validationDiv.innerHTML = '<span class="text-orange-600">⚠️ Cannot verify. You can still submit.</span>';
          submitButton.disabled = false;
          return;
        }

        fetch('/check_availability', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken.content,
            'Accept': 'application/json'
          },
          body: JSON.stringify({ short_uri: value })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.available) {
            validationDiv.innerHTML = '<span class="text-green-600 font-medium">✓ This short code is available!</span>';
            submitButton.disabled = false;
          } else {
            validationDiv.innerHTML = '<span class="text-red-600 font-medium">❌ ' + data.message + '</span>';
            submitButton.disabled = true;
          }
        })
        .catch(error => {
          console.error('Fetch error:', error);
          validationDiv.innerHTML = '<span class="text-orange-600">⚠️ Cannot verify availability. You can still submit.</span>';
          submitButton.disabled = false;
        });
      }, 500);
    });
  </script>
<% end %>