<%= render layout: 'layouts/dashboard_layout' do %>
<div class="container mx-auto px-3 py-4 max-w-6xl">
  <!-- Header -->
  <div class="mb-4 flex items-center justify-between ">
    <h1 class="text-xl font-bold mb-1">Analytics for /<%= @short_url.short_uri %></h1>
    <div class="text-xs text-gray-600 space-x-2 flex items-center justify-center">
      <p><strong>URL 1:</strong> <%= @short_url.url1 %></p>
      <% if @short_url.url2.present? %>
        <p><strong>URL 2:</strong> <%= @short_url.url2 %></p>
      <% end %>
    </div>
  </div>

  <!-- Combined Summary Card with Animated Chart -->
<div class="bg-white rounded-lg shadow-sm p-3 mb-3">
  <h3 class="text-gray-700 text-xs font-semibold mb-2 text-center">Traffic Overview</h3>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-center">
    <!-- Animated Pie Chart -->
    <div class="flex items-center justify-center" style="height: 200px;">
      <canvas id="combinedPieChart"></canvas>
    </div>
    <!-- Stats Summary -->
    <div class="space-y-2">
      <!-- Total Clicks -->
      <div class="text-center p-1.5 bg-blue-50 rounded">
        <p class="text-xl font-bold text-blue-600"><%= @stats[:total_clicks] %></p>
        <p class="text-xs text-gray-600">Total Clicks</p>
      </div>
      
      <!-- URL Breakdown -->
      <div class="grid grid-cols-2 gap-1.5">
        <% 
          # Create a hash for easy lookup
          url_data = {}
          @stats[:url_type_breakdown].each do |stat|
            url_data[stat['url_type']] = stat
          end
          
          # Display both URL1 and URL2, with defaults if missing
          ['url1', 'url2'].each do |url_type|
            stat = url_data[url_type] || {'url_type' => url_type, 'count' => 0, 'unique_visitors' => 0}
        %>
          <div class="text-center p-1.5 bg-gray-50 rounded border border-gray-200">
            <p class="text-xs text-gray-500"><%= stat['url_type'].upcase %></p>
            <p class="text-lg font-bold <%= stat['url_type'] == 'url1' ? 'text-blue-600' : 'text-green-600' %>">
              <%= stat['count'] %>
            </p>
            <p class="text-xs text-gray-400"><%= stat['unique_visitors'] %> unique</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

  <!-- Clicks Over Time -->
  <div class="bg-white rounded-lg shadow-sm p-3 mb-3">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-sm font-semibold">Clicks Over Time</h2>
      <div class="flex gap-1.5">
        <button onclick="updateTimeRange(7)" id="btn-7days" class="px-3 py-2 text-xs rounded-md bg-indigo-600 text-white font-medium hover:bg-indigo-700 transition">
          7 Days
        </button>
        <button onclick="updateTimeRange(30)" id="btn-30days" class="px-3 py-2 text-xs rounded-md bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition">
          30 Days
        </button>
      </div>
    </div>
    <div class="h-48">
      <canvas id="clicksBarChart"></canvas>
    </div>
  </div>

  <!-- Device & Browser Stats Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
    <!-- Device Stats -->
    <div class="bg-white rounded-lg shadow-sm p-3">
      <h2 class="text-sm font-semibold mb-2">Device Types</h2>
      <div class="space-y-1">
        <% @stats[:device_stats].each do |stat| %>
          <div class="flex justify-between items-center text-xs py-1.5 border-b border-gray-100 last:border-0">
            <span class="font-medium capitalize text-gray-700"><%= stat['device_type'] %></span>
            <div class="flex items-center gap-2">
              <span class="text-gray-600"><%= stat['clicks'] %></span>
              <span class="text-gray-400 text-xs">(<%= stat['unique_visitors'] %> unique)</span>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Browser Stats -->
    <div class="bg-white rounded-lg shadow-sm p-3">
      <h2 class="text-sm font-semibold mb-2">Top Browsers</h2>
      <div class="space-y-1">
        <% @stats[:browser_stats].first(5).each do |stat| %>
          <div class="flex justify-between items-center text-xs py-1.5 border-b border-gray-300">
            <span class="font-medium text-gray-700"><%= stat['browser'] %> <%= stat['browser_version'] %></span>
            <span class="text-gray-600"><%= stat['clicks'] %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Geographic Stats -->
  <% if @stats[:geographic_stats].any? %>
  <div class="bg-white rounded-lg shadow-sm p-3 mb-3">
    <h2 class="text-sm font-semibold mb-2">Geographic Distribution</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-xs">
        <thead>
          <tr class="border-b border-gray-200">
            <th class="text-left py-1.5 px-2 font-medium text-gray-600">Country</th>
            <th class="text-left py-1.5 px-2 font-medium text-gray-600">City</th>
            <th class="text-right py-1.5 px-2 font-medium text-gray-600">Clicks</th>
            <th class="text-right py-1.5 px-2 font-medium text-gray-600">Unique</th>
          </tr>
        </thead>
        <tbody>
          <% @stats[:geographic_stats].first(6).each do |row| %>
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
              <td class="py-1.5 px-2"><%= row['country'].presence || 'Unknown' %></td>
              <td class="py-1.5 px-2"><%= row['city'].presence || 'Unknown' %></td>
              <td class="text-right py-1.5 px-2"><%= row['clicks'] %></td>
              <td class="text-right py-1.5 px-2"><%= row['unique_visitors'] %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  <% end %>

  <!-- Referrer Stats -->
  <div class="bg-white rounded-lg shadow-sm p-3 mb-3">
    <h2 class="text-sm font-semibold mb-2">Top Referrers</h2>
    <div class="space-y-1">
      <% if @stats[:referrer_stats].any? %>
        <% @stats[:referrer_stats].first(6).each do |stat| %>
          <div class="flex justify-between items-center text-xs py-1.5 border-b border-gray-100 last:border-0">
            <span class="font-medium text-gray-700"><%= stat['referrer_domain'] %></span>
            <div class="flex items-center gap-2">
              <span class="text-gray-600"><%= stat['clicks'] %></span>
              <span class="text-gray-400 text-xs">(<%= stat['unique_visitors'] %> unique)</span>
            </div>
          </div>
        <% end %>
      <% else %>
        <p class="text-gray-400 text-xs">No referrer data available</p>
      <% end %>
    </div>
  </div>
  <!-- UTM Campaign Performance -->
  <% if @stats[:utm_campaign_stats].any? %>
  <div class="bg-white rounded-lg shadow-sm p-3 mb-3">
    <h2 class="text-sm font-semibold mb-2">üìä UTM Campaign Performance</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-xs">
        <thead>
          <tr class="border-b border-gray-200">
            <th class="text-left py-1.5 px-2 font-medium text-gray-600">Campaign</th>
            <th class="text-left py-1.5 px-2 font-medium text-gray-600">Source</th>
            <th class="text-left py-1.5 px-2 font-medium text-gray-600">Medium</th>
            <th class="text-right py-1.5 px-2 font-medium text-gray-600">Clicks</th>
            <th class="text-right py-1.5 px-2 font-medium text-gray-600">Unique</th>
          </tr>
        </thead>
        <tbody>
          <% @stats[:utm_campaign_stats].first(10).each do |stat| %>
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
              <td class="py-1.5 px-2">
                <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                  <%= stat['utm_campaign'] %>
                </span>
              </td>
              <td class="py-1.5 px-2 text-gray-600"><%= stat['utm_source'] %></td>
              <td class="py-1.5 px-2 text-gray-600"><%= stat['utm_medium'] %></td>
              <td class="text-right py-1.5 px-2 font-semibold"><%= stat['clicks'] %></td>
              <td class="text-right py-1.5 px-2 text-gray-500"><%= stat['unique_visitors'] %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  <% end %>

<!-- UTM Source & Medium Grid -->
  <% if @stats[:utm_source_stats].any? || @stats[:utm_medium_stats].any? %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
    <!-- UTM Sources -->
    <% if @stats[:utm_source_stats].any? %>
    <div class="bg-white rounded-lg shadow-sm p-3">
      <h2 class="text-sm font-semibold mb-2">üåê Traffic Sources</h2>
      <div class="space-y-1">
        <% @stats[:utm_source_stats].first(8).each do |stat| %>
          <div class="flex justify-between items-center text-xs py-1.5 border-b border-gray-100 last:border-0">
            <span class="font-medium text-gray-700 capitalize"><%= stat['utm_source'] %></span>
            <div class="flex items-center gap-2">
              <span class="text-gray-600"><%= stat['clicks'] %></span>
              <span class="text-gray-400 text-xs">(<%= stat['unique_visitors'] %> unique)</span>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>
  
    <!-- UTM Mediums -->
    <% if @stats[:utm_medium_stats].any? %>
    <div class="bg-white rounded-lg shadow-sm p-3">
      <h2 class="text-sm font-semibold mb-2">üì± Marketing Mediums</h2>
      <div class="space-y-1">
        <% @stats[:utm_medium_stats].first(8).each do |stat| %>
          <div class="flex justify-between items-center text-xs py-1.5 border-b border-gray-100 last:border-0">
            <span class="font-medium text-gray-700 capitalize"><%= stat['utm_medium'] %></span>
            <div class="flex items-center gap-2">
              <span class="text-gray-600"><%= stat['clicks'] %></span>
              <span class="text-gray-400 text-xs">(<%= stat['unique_visitors'] %> unique)</span>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>
  </div>
  <% end %>



  <!-- Hourly Pattern -->
  <div class="bg-white rounded-lg shadow-sm p-3 mb-3">
    <h2 class="text-sm font-semibold mb-2">Hourly Click Pattern (Last 7 Days)</h2>
    <div class="space-y-0.5">
      <% @stats[:hourly_pattern].each do |stat| %>
        <div class="flex items-center gap-2">
          <span class="w-10 text-xs text-right text-gray-600"><%= stat['hour'] %>:00</span>
          <div class="flex-1 bg-gray-100 rounded-full h-4 relative overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full h-4 transition-all duration-500 ease-out hourly-bar" 
                 style="width: <%= [stat['clicks'].to_f / @stats[:hourly_pattern].max_by { |s| s['clicks'] }['clicks'] * 100, 2].max %>%">
            </div>
          </div>
          <span class="w-10 text-xs text-gray-600"><%= stat['clicks'] %></span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Recent Clicks -->
  <div class="bg-white rounded-lg shadow-sm p-3 mb-3">
    <h2 class="text-sm font-semibold mb-2">Recent Clicks (Last 50)</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-xs">
        <thead>
          <tr class="border-b border-gray-200">
            <th class="text-left py-1.5 px-1.5 font-medium text-gray-600">Time</th>
            <th class="text-left py-1.5 px-1.5 font-medium text-gray-600">URL</th>
            <th class="text-left py-1.5 px-1.5 font-medium text-gray-600">Device</th>
            <th class="text-left py-1.5 px-1.5 font-medium text-gray-600">Browser</th>
            <th class="text-left py-1.5 px-1.5 font-medium text-gray-600">Location</th>
            <th class="text-left py-1.5 px-1.5 font-medium text-gray-600">Referrer</th>
          </tr>
        </thead>
        <tbody>
          <% @recent_clicks.each do |click| %>
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
              <td class="py-1.5 px-1.5 text-gray-600"><%= click.clicked_at.strftime("%m/%d %H:%M") %></td>
              <td class="py-1.5 px-1.5">
                <span class="px-1.5 py-0.5 rounded-full text-xs font-medium <%= click.url_type == 'url1' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700' %>">
                  <%= click.url_type %>
                </span>
              </td>
              <td class="py-1.5 px-1.5 capitalize text-gray-600"><%= click.device_type %></td>
              <td class="py-1.5 px-1.5 text-gray-600"><%= click.browser %></td>
              <td class="py-1.5 px-1.5 text-gray-600"><%= [click.city, click.country].compact.join(", ").presence || "Unknown" %></td>
              <td class="py-1.5 px-1.5 text-gray-600"><%= click.referrer_domain || "Direct" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

<div class="mt-4">
    <%= link_to "‚Üê Back to Short URLs", short_urls_path, class: "text-indigo-600 hover:text-indigo-700 font-medium text-xs transition" %>
</div>
</div>

<style>
  @keyframes slideIn {
    from {
      width: 0;
    }
    to {
      width: var(--target-width);
    }
  }
  
  .hourly-bar {
    animation: slideIn 0.8s ease-out;
  }
</style>

<script data-turbo-track="reload">
  document.addEventListener('DOMContentLoaded', initializeCharts);
  document.addEventListener('turbo:load', initializeCharts);
  
  function initializeCharts() {
    const statsData = <%= raw @stats.to_json %>;
    const shortUrlId = <%= @short_url.id %>;
    
    if (typeof Chart === 'undefined') {
      console.error('Chart.js is not loaded');
      return;
    }
    
    // Combined Animated Pie Chart
    const clicksData = statsData.url_type_breakdown;
    const combinedPieCanvas = document.getElementById('combinedPieChart');
    
    if (combinedPieCanvas) {
      const combinedPieCtx = combinedPieCanvas.getContext('2d');
      
      new Chart(combinedPieCtx, {
        type: 'doughnut',
        data: {
          labels: clicksData.map(d => `${d.url_type.toUpperCase()} (${d.count} clicks, ${d.unique_visitors} unique)`),
          datasets: [{
            data: clicksData.map(d => d.count),
            backgroundColor: [
              'rgba(59, 130, 246, 0.8)',
              'rgba(16, 185, 129, 0.8)'
            ],
            borderColor: [
              'rgba(59, 130, 246, 1)',
              'rgba(16, 185, 129, 1)'
            ],
            borderWidth: 1,
            hoverOffset: 6,
            hoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 4,
                font: { 
                  size: 8,
                  weight: '500'
                },
                usePointStyle: true,
                pointStyle: 'circle',
                boxWidth: 5,
                boxHeight: 5
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 6,
              titleFont: { size: 10, weight: 'bold' },
              bodyFont: { size: 9 },
              cornerRadius: 4
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1200,
            easing: 'easeInOutQuart'
          }
        }
      });
    }

    window.statsData = statsData;
    window.shortUrlId = shortUrlId;
    createBarChart(7);
  }
  
  function createBarChart(days) {
    const clicksBarCanvas = document.getElementById('clicksBarChart');
    if (!clicksBarCanvas) return;
    
    const clicksBarCtx = clicksBarCanvas.getContext('2d');
    const timeData = window.statsData.clicks_over_time;
    
    const dates = [...new Set(timeData.map(d => d.date))].sort();
    
    const url1Data = dates.map(date => {
      const item = timeData.find(d => d.date === date && d.url_type === 'url1');
      return item ? item.clicks : 0;
    });
    
    const url2Data = dates.map(date => {
      const item = timeData.find(d => d.date === date && d.url_type === 'url2');
      return item ? item.clicks : 0;
    });
    
    if (window.clicksBarChart && typeof window.clicksBarChart.destroy === 'function') {
      window.clicksBarChart.destroy();
    }
    
    window.clicksBarChart = new Chart(clicksBarCtx, {
      type: 'bar',
      data: {
        labels: dates,
        datasets: [
          {
            label: 'URL 1',
            data: url1Data,
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: 'rgba(37, 99, 235, 1)',
            borderWidth: 1,
            borderRadius: 3
          },
          {
            label: 'URL 2',
            data: url2Data,
            backgroundColor: 'rgba(16, 185, 129, 0.8)',
            borderColor: 'rgba(5, 150, 105, 1)',
            borderWidth: 1,
            borderRadius: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
              font: { size: 9 }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: { size: 9 }
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              padding: 8,
              font: { size: 10 },
              usePointStyle: true,
              boxWidth: 8,
              boxHeight: 8
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 8,
            cornerRadius: 4,
            titleFont: { size: 10 },
            bodyFont: { size: 9 }
          }
        },
        animation: {
          duration: 800,
          easing: 'easeInOutQuart'
        }
      }
    });
  }
  
  function updateTimeRange(days) {
    document.getElementById('btn-7days').className = days === 7 
      ? 'px-2 py-1 text-xs rounded-md bg-indigo-600 text-white font-medium hover:bg-indigo-700 transition'
      : 'px-2 py-1 text-xs rounded-md bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition';
    
    document.getElementById('btn-30days').className = days === 30
      ? 'px-2 py-1 text-xs rounded-md bg-indigo-600 text-white font-medium hover:bg-indigo-700 transition'
      : 'px-2 py-1 text-xs rounded-md bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition';
    
    fetch(`/short_urls/${window.shortUrlId}/stats.json?days=${days}`)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        window.statsData.clicks_over_time = data.clicks_over_time;
        createBarChart(days);
      })
      .catch(error => console.error('Error fetching data:', error));
  }
</script>
<% end %>