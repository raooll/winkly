

<div class="container mx-auto px-4 py-8">
  <div class="mb-6">
    <h1 class="text-3xl font-bold mb-2">Analytics for /<%= @short_url.short_uri %></h1>
    <div class="text-gray-600">
      <p><strong>URL 1:</strong> <%= @short_url.url1 %></p>
      <% if @short_url.url2.present? %>
        <p><strong>URL 2:</strong> <%= @short_url.url2 %></p>
      <% end %>
    </div>
  </div>

  <!-- Summary Cards with Pie Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Total Clicks Card -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-gray-700 text-lg font-semibold mb-4 text-center">Total Clicks Distribution</h3>
      <div class="flex items-center justify-center">
        <canvas id="clicksPieChart" width="300" height="300"></canvas>
      </div>
      <div class="text-center mt-4">
        <p class="text-5xl font-bold text-blue-600"><%= @stats[:total_clicks] %></p>
        <p class="text-gray-500 mt-2">Total Clicks</p>
      </div>
    </div>

    <!-- Unique Visitors Card -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-gray-700 text-lg font-semibold mb-4 text-center">Unique Visitors by URL</h3>
      <div class="flex items-center justify-center">
        <canvas id="visitorsPieChart" width="300" height="300"></canvas>
      </div>
      <div class="grid grid-cols-2 gap-4 mt-6">
        <% @stats[:url_type_breakdown].each do |stat| %>
          <div class="text-center">
            <p class="text-2xl font-bold <%= stat['url_type'] == 'url1' ? 'text-blue-600' : 'text-green-600' %>">
              <%= stat['unique_visitors'] %>
            </p>
            <p class="text-sm text-gray-500"><%= stat['url_type'].upcase %> Unique</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Clicks Over Time with Bar Chart -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold">Clicks Over Time</h2>
      <div class="flex gap-2">
        <button onclick="updateTimeRange(7)" id="btn-7days" class="px-4 py-2 rounded bg-blue-600 text-white font-medium hover:bg-blue-700 transition">
          7 Days
        </button>
        <button onclick="updateTimeRange(30)" id="btn-30days" class="px-4 py-2 rounded bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition">
          30 Days
        </button>
      </div>
    </div>
    <div class="h-80">
      <canvas id="clicksBarChart"></canvas>
    </div>
  </div>

  <!-- Device Stats -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4">Device Types</h2>
    <div class="space-y-2">
      <% @stats[:device_stats].each do |stat| %>
        <div class="flex justify-between items-center">
          <span class="font-medium capitalize"><%= stat['device_type'] %></span>
          <div class="flex items-center gap-4">
            <span class="text-gray-600"><%= stat['clicks'] %> clicks</span>
            <span class="text-gray-500 text-sm">(<%= stat['unique_visitors'] %> unique)</span>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Geographic Stats -->
  <% if @stats[:geographic_stats].any? %>
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4">Geographic Distribution</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead>
          <tr class="border-b">
            <th class="text-left py-2 px-4">Country</th>
            <th class="text-left py-2 px-4">City</th>
            <th class="text-right py-2 px-4">Clicks</th>
            <th class="text-right py-2 px-4">Unique Visitors</th>
          </tr>
        </thead>
        <tbody>
          <% @stats[:geographic_stats].first(10).each do |row| %>
            <tr class="border-b hover:bg-gray-50">
              <td class="py-2 px-4"><%= row['country'].presence || 'Unknown' %></td>
              <td class="py-2 px-4"><%= row['city'].presence || 'Unknown' %></td>
              <td class="text-right py-2 px-4"><%= row['clicks'] %></td>
              <td class="text-right py-2 px-4"><%= row['unique_visitors'] %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  <% end %>

  <!-- Browser Stats -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4">Browser Statistics</h2>
    <div class="space-y-2">
      <% @stats[:browser_stats].first(10).each do |stat| %>
        <div class="flex justify-between items-center">
          <span class="font-medium"><%= stat['browser'] %> <%= stat['browser_version'] %></span>
          <span class="text-gray-600"><%= stat['clicks'] %> clicks</span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Referrer Stats -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4">Top Referrers</h2>
    <div class="space-y-2">
      <% if @stats[:referrer_stats].any? %>
        <% @stats[:referrer_stats].first(10).each do |stat| %>
          <div class="flex justify-between items-center">
            <span class="font-medium"><%= stat['referrer_domain'] %></span>
            <div class="flex items-center gap-4">
              <span class="text-gray-600"><%= stat['clicks'] %> clicks</span>
              <span class="text-gray-500 text-sm">(<%= stat['unique_visitors'] %> unique)</span>
            </div>
          </div>
        <% end %>
      <% else %>
        <p class="text-gray-500">No referrer data available</p>
      <% end %>
    </div>
  </div>

  <!-- Hourly Pattern -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4">Hourly Click Pattern (Last 7 Days)</h2>
    <div class="space-y-1">
      <% @stats[:hourly_pattern].each do |stat| %>
        <div class="flex items-center gap-4">
          <span class="w-16 text-right"><%= stat['hour'] %>:00</span>
          <div class="flex-1 bg-gray-200 rounded h-6">
            <div class="bg-blue-600 rounded h-6" style="width: <%= [stat['clicks'].to_f / @stats[:hourly_pattern].max_by { |s| s['clicks'] }['clicks'] * 100, 5].max %>%"></div>
          </div>
          <span class="w-16"><%= stat['clicks'] %> clicks</span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Recent Clicks -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-2xl font-bold mb-4">Recent Clicks (Last 50)</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="border-b">
            <th class="text-left py-2 px-2">Time</th>
            <th class="text-left py-2 px-2">URL</th>
            <th class="text-left py-2 px-2">Device</th>
            <th class="text-left py-2 px-2">Browser</th>
            <th class="text-left py-2 px-2">Location</th>
            <th class="text-left py-2 px-2">Referrer</th>
          </tr>
        </thead>
        <tbody>
          <% @recent_clicks.each do |click| %>
            <tr class="border-b hover:bg-gray-50">
              <td class="py-2 px-2"><%= click.clicked_at.strftime("%Y-%m-%d %H:%M") %></td>
              <td class="py-2 px-2">
                <span class="px-2 py-1 rounded text-xs <%= click.url_type == 'url1' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800' %>">
                  <%= click.url_type %>
                </span>
              </td>
              <td class="py-2 px-2 capitalize"><%= click.device_type %></td>
              <td class="py-2 px-2"><%= click.browser %></td>
              <td class="py-2 px-2"><%= [click.city, click.country].compact.join(", ").presence || "Unknown" %></td>
              <td class="py-2 px-2"><%= click.referrer_domain || "Direct" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-8">
    <%= link_to "â† Back to Short URLs", short_urls_path, class: "text-blue-600 hover:underline" %>
  </div>
</div>

<script data-turbo-track="reload">
  document.addEventListener('DOMContentLoaded', initializeCharts);
  document.addEventListener('turbo:load', initializeCharts);
  
  function initializeCharts() {
    // Data from Rails
    const statsData = <%= raw @stats.to_json %>;
    const shortUrlId = <%= @short_url.id %>;
    
    // Wait for Chart.js to be available
    if (typeof Chart === 'undefined') {
      console.error('Chart.js is not loaded');
      return;
    }
    
    // Pie Chart for Clicks Distribution
    const clicksData = statsData.url_type_breakdown;
    const clicksPieCanvas = document.getElementById('clicksPieChart');
    if (clicksPieCanvas) {
      const clicksPieCtx = clicksPieCanvas.getContext('2d');
      new Chart(clicksPieCtx, {
        type: 'pie',
        data: {
          labels: clicksData.map(d => d.url_type.toUpperCase()),
          datasets: [{
            data: clicksData.map(d => d.count),
            backgroundColor: ['#3B82F6', '#10B981'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: { size: 14 }
              }
            }
          }
        }
      });
    }

    // Pie Chart for Unique Visitors
    const visitorsPieCanvas = document.getElementById('visitorsPieChart');
    if (visitorsPieCanvas) {
      const visitorsPieCtx = visitorsPieCanvas.getContext('2d');
      new Chart(visitorsPieCtx, {
        type: 'pie',
        data: {
          labels: clicksData.map(d => d.url_type.toUpperCase()),
          datasets: [{
            data: clicksData.map(d => d.unique_visitors),
            backgroundColor: ['#3B82F6', '#10B981'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: { size: 14 }
              }
            }
          }
        }
      });
    }

    // Initialize bar chart
    window.statsData = statsData;
    window.shortUrlId = shortUrlId;
    createBarChart(7);
  }
  
  // Bar Chart for Clicks Over Time
  function createBarChart(days) {
    const clicksBarCanvas = document.getElementById('clicksBarChart');
    if (!clicksBarCanvas) return;
    
    const clicksBarCtx = clicksBarCanvas.getContext('2d');
    const timeData = window.statsData.clicks_over_time;
    
    // Get unique dates and sort them
    const dates = [...new Set(timeData.map(d => d.date))].sort();
    
    // Prepare datasets for URL1 and URL2
    const url1Data = dates.map(date => {
      const item = timeData.find(d => d.date === date && d.url_type === 'url1');
      return item ? item.clicks : 0;
    });
    
    const url2Data = dates.map(date => {
      const item = timeData.find(d => d.date === date && d.url_type === 'url2');
      return item ? item.clicks : 0;
    });
    
    // Destroy existing chart if it exists and is a Chart instance
    if (window.clicksBarChart && typeof window.clicksBarChart.destroy === 'function') {
      window.clicksBarChart.destroy();
    }
    
    window.clicksBarChart = new Chart(clicksBarCtx, {
      type: 'bar',
      data: {
        labels: dates,
        datasets: [
          {
            label: 'URL 1',
            data: url1Data,
            backgroundColor: '#3B82F6',
            borderColor: '#2563EB',
            borderWidth: 1
          },
          {
            label: 'URL 2',
            data: url2Data,
            backgroundColor: '#10B981',
            borderColor: '#059669',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              padding: 15,
              font: { size: 14 }
            }
          }
        }
      }
    });
  }
  
  // Update time range
  function updateTimeRange(days) {
    // Update button styles
    document.getElementById('btn-7days').className = days === 7 
      ? 'px-4 py-2 rounded bg-blue-600 text-white font-medium hover:bg-blue-700 transition'
      : 'px-4 py-2 rounded bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition';
    
    document.getElementById('btn-30days').className = days === 30
      ? 'px-4 py-2 rounded bg-blue-600 text-white font-medium hover:bg-blue-700 transition'
      : 'px-4 py-2 rounded bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition';
    
    // Fetch new data
    fetch(`/short_urls/${window.shortUrlId}/stats.json?days=${days}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        window.statsData.clicks_over_time = data.clicks_over_time;
        createBarChart(days);
      })
      .catch(error => console.error('Error fetching data:', error));
  }
</script>

